<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clientes GPON Borrados - SUPER USHUAIA</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .expandible { transition: all .2s ease; }
    .btn-plus { width: 34px; height: 34px; display: inline-flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <div class="max-w-6xl mx-auto py-6 px-4">
    <h1 class="text-2xl font-bold text-center mb-6 text-blue-700">PROBABLES DATOS GPON (VERIFICAR)</h1>

    <div class="grid md:grid-cols-2 gap-4 mb-6">
      <select id="filtroNodo" class="p-2 border rounded">
        <option value="">Filtrar por Nodo</option>
      </select>

      <select id="filtroNAP" class="p-2 border rounded">
        <option value="">Filtrar por NAP</option>
      </select>
    </div>

    <div class="overflow-x-auto bg-white rounded shadow">
      <table class="min-w-full">
        <thead class="bg-blue-700 text-white">
          <tr>
            <th class="py-2 px-3 text-left"># Cliente</th>
            <th class="py-2 px-3 text-left">NAP</th>
            <th class="py-2 px-3 text-left">Nodo</th>
            <th class="py-2 px-3 text-left">Puerto</th>
            <th class="py-2 px-3 text-center">+</th>
          </tr>
        </thead>
        <tbody id="tablaClientes"></tbody>
      </table>
    </div>

    <p id="actualizado" class="text-center text-sm text-gray-500 mt-4"></p>

    <div class="text-center mt-6">
      <a href="index.html" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800">⬅ Volver al inicio</a>
    </div>
  </div>

  <script>
    let clientesProbables = [];
    let clientesBorrados = [];

    async function cargarDatos() {
      try {
        const [probableRes, borradosRes] = await Promise.all([
          fetch("data/probable_gpon.json"),
          fetch("data/clientes_gpon_borrados.json")
        ]);

        if (!probableRes.ok) throw new Error("No se encontró data/probable_gpon.json (HTTP " + probableRes.status + ")");
        if (!borradosRes.ok) console.warn("Advertencia: clientes_gpon_borrados.json no encontrado (HTTP " + borradosRes.status + ")");

        const probableData = await probableRes.json();
        const borradosData = borradosRes.ok ? await borradosRes.json() : { clientes: [] };

        clientesProbables = Array.isArray(probableData.clientes) ? probableData.clientes : [];
        clientesBorrados = Array.isArray(borradosData.clientes) ? borradosData.clientes : [];

        document.getElementById("actualizado").textContent =
          "Última actualización: " + (probableData.actualizado || "-");

        poblarFiltros();
        mostrarClientes();
      } catch (err) {
        console.error("Error cargando datos:", err);
        document.getElementById("tablaClientes").innerHTML =
          `<tr><td colspan="5" class="p-4 text-center text-red-600">Error al cargar los datos: ${err.message}</td></tr>`;
      }
    }

    function poblarFiltros() {
      const filtroNodo = document.getElementById("filtroNodo");
      const filtroNAP = document.getElementById("filtroNAP");

      const nodos = [...new Set(clientesProbables.map(c => (c.nodo || "").toString().trim()).filter(Boolean))].sort();
      const naps = [...new Set(clientesProbables.map(c => (c.nap || "").toString().trim()).filter(Boolean))].sort();

      filtroNodo.querySelectorAll("option:not(:first-child)").forEach(n => n.remove());
      filtroNAP.querySelectorAll("option:not(:first-child)").forEach(n => n.remove());

      nodos.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        filtroNodo.appendChild(opt);
      });

      naps.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        filtroNAP.appendChild(opt);
      });

      filtroNodo.addEventListener("change", mostrarClientes);
      filtroNAP.addEventListener("change", mostrarClientes);
    }

    function safeString(v) {
      if (v === null || v === undefined) return "";
      if (Number.isNaN(v)) return "";
      return String(v);
    }

    function mostrarClientes() {
      const nodoSel = document.getElementById("filtroNodo").value;
      const napSel = document.getElementById("filtroNAP").value;
      const tbody = document.getElementById("tablaClientes");
      tbody.innerHTML = "";

      const filtrados = clientesProbables.filter(c =>
        (!nodoSel || (safeString(c.nodo) === nodoSel)) &&
        (!napSel || (safeString(c.nap) === napSel))
      ).sort((a, b) => {
        const pa = Number(a.puerto) || 0;
        const pb = Number(b.puerto) || 0;
        if (pa !== pb) return pa - pb;
        return (safeString(a.numero_cliente)).localeCompare(safeString(b.numero_cliente), undefined, {numeric: true});
      });

      if (filtrados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-600">No se encontraron clientes con esos filtros.</td></tr>`;
        return;
      }

      filtrados.forEach(c => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";

        const nro = safeString(c.numero_cliente) || "-";
        const nap = safeString(c.nap) || "-";
        const nodo = safeString(c.nodo) || "-";
        const puerto = (c.puerto !== null && c.puerto !== undefined && !Number.isNaN(Number(c.puerto))) ? c.puerto : "-";

        // Verificar si este cliente existe en el JSON de borrados
        const existeBorrado = clientesBorrados.some(b => safeString(b.numero_cliente) === nro);

        tr.innerHTML = `
          <td class="py-2 px-3">${nro}</td>
          <td class="py-2 px-3">${nap}</td>
          <td class="py-2 px-3">${nodo}</td>
          <td class="py-2 px-3">${puerto}</td>
          <td class="py-2 px-3 text-center">${existeBorrado ? '<button class="btn-plus bg-green-600 text-white rounded px-2 py-1 hover:bg-green-700">+</button>' : ''}</td>
        `;

        if (existeBorrado) {
          const btn = tr.querySelector("button");
          btn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            toggleExpandir(nro, btn);
          });
        }

        tbody.appendChild(tr);
      });
    }

    function toggleExpandir(numeroCliente, boton) {
      const fila = boton.closest("tr");
      const siguiente = fila.nextElementSibling;

      if (siguiente && siguiente.classList.contains("expandible")) {
        siguiente.remove();
        boton.innerText = "+";
        return;
      }

      const encontrado = clientesBorrados.find(c => safeString(c.numero_cliente) === safeString(numeroCliente));

      const nuevaFila = document.createElement("tr");
      nuevaFila.className = "expandible bg-gray-100";

      if (encontrado) {
        const nombre = safeString(encontrado.nombre) || "-";
        const domicilio = safeString(encontrado.domicilio) || "-";
        const estado = safeString(encontrado.estado) || "-";
        const precinto = safeString(encontrado.precinto) || "-";

        nuevaFila.innerHTML = `
          <td colspan="5" class="p-4 text-sm">
            <div class="grid md:grid-cols-2 gap-2">
              <div><strong>Nombre:</strong> ${nombre}</div>
              <div><strong>Precinto:</strong> ${precinto}</div>
              <div class="md:col-span-2"><strong>Domicilio:</strong> ${domicilio}</div>
              <div><strong>Estado:</strong> ${estado}</div>
            </div>
          </td>
        `;
      }

      fila.insertAdjacentElement("afterend", nuevaFila);
      boton.innerText = "−";
    }

    cargarDatos();
  </script>

</body>
</html>
